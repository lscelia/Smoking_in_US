---
title: "Quit Smoking"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: sandstone
---

```{r, message = FALSE}
#import library
library(tidyverse)
library(dplyr)
library(plotly)
library(haven)
library(viridis)

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "right"))

# specify some map projection/options
g = list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
```


According to CDC, fewer than one in ten adult cigarette smokers succeed in quitting smoking each year. In 2018, only 7.5% of adult smokers successfully quit smoking in the past year. In this page, we aim to analysis the group of people who are willing or trying to quit smoking in 2020. 


## Tried Quit Smoking?
```{r, message = FALSE}
smk_df = read_csv("./data/adult20.csv")

smk_df = 
  smk_df %>% 
  janitor::clean_names() %>% 
  rename(try_quit = smkqt12m_a, 
         doctor_quit = smktlk_a, 
         time_quit = smkqtnp_a) %>%
  select(try_quit, doctor_quit, time_quit) %>% 
  filter(if_any(everything(), ~ !is.na(.)))

try_quit_plot = 
  smk_df %>% 
  select(try_quit) %>% 
  drop_na() %>% 
  mutate(
    try_quit = as.character(try_quit),
    try_quit = str_replace(try_quit, "1", "Yes"),
    try_quit = str_replace(try_quit, "2", "No"),
    try_quit = str_replace(try_quit, "7", "Refused"),
    try_quit = str_replace(try_quit, "8", "Not Ascertained"),
    try_quit = str_replace(try_quit, "9", "Don't Know")
  ) %>% 
  group_by(try_quit) %>% 
  count() %>% 
  plot_ly(labels = ~try_quit, values = ~n, type = "pie", width = 500, 
          height = 500,marker = list(colors = c("#9ACD32", "#87CEEB", "#FA8072", 
                           "#FFFACD", "	#F5DEB3"))) %>% 
  layout(title = "Have you tried to stop smoking during the past year? ")

try_quit_plot
```

This pie chart illustrates the willingness to quit smoking of the smokers who answered the survey. Less than half, 46.1%, of the people have tried to stop smoking in 2020. Interested in this outcome, we investigate the number of days that these people persist in stop smoking, which is presented in the bar chart shown below:


## Time since quitting smoking
```{r, warning = FALSE}
time_quit_plot = 
  smk_df %>% 
  select(time_quit) %>% 
  mutate(
    period = cut(time_quit, breaks = seq(0, 365, by = 7))
  ) %>% 
  drop_na() %>% 
  group_by(period) %>% 
  count() %>% 
  plot_ly(y = ~n, type = "bar", color = ~n,
          #add text above the bars
          text = ~n, textposition = 'auto' ) %>% 
  layout(title = "Time since quitting (Weeks)", 
         xaxis = list(title = "Weeks"),
         yaxis = list(title = "Number of People"))
  
time_quit_plot
```

As shown in the bar chart, it is can be seemed that only a few people have quitted smoking for more than 10 weeks when they answered this survey. However, it usually takes around 12 weeks to withdraw all nicotine symptoms, despite heavy or light smokers. Many of them tried to stop smoking for less than 3 weeks. Due to limited data points, we were unable to examine whether these people quit smoking successfully in 2021. Therefore, the number of people who quit smoking in 2020 may increase.


In the sections below, we explore factors that may trigger smokers to quit smoking. We studied the effect of doctorâ€™s advice and tobacco tax in contributing quit smoking. 


## Doctors' Advice
```{r}
doctor_quit = 
  smk_df %>% 
  select(doctor_quit) %>% 
  drop_na() %>% 
  mutate(
    doctor_quit = as.character(doctor_quit),
    doctor_quit = str_replace(doctor_quit, "1", "Yes"),
    doctor_quit = str_replace(doctor_quit, "2", "No"),
    doctor_quit = str_replace(doctor_quit, "7", "Refused"),
    doctor_quit = str_replace(doctor_quit, "8", "Not Ascertained"),
    doctor_quit = str_replace(doctor_quit, "9", "Don't Know")
  ) %>% 
  group_by(doctor_quit) %>% 
  count()  %>% 
  plot_ly(labels = ~doctor_quit, values = ~n, type = "pie", width = 500, 
          height = 500, marker = list(colors = c("#9ACD32", "#87CEEB", 
                           "#11AA22", "#FA8072",	"#F5DEB3"))) %>% 
  layout(title = "Has a doctor advised you about stop smoking 
         last year? ")

doctor_quit
```


## Calls Related to Quit Smoking
```{r}
quit_df = read.csv("./data/Quitline_Service_Utilization.csv") 

quit_df %>% 
  janitor::clean_names() %>% 
  filter(year == 2020,
         variable == "Counseling and/or Medications",
         location_abbr != "US") %>% 
  mutate(number_of_calls = value / 1000) %>% 
  select(location_abbr, number_of_calls) %>%
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(z = ~number_of_calls, text = "#Calls", locations = ~location_abbr,
            color = ~number_of_calls, colors = "Blues") %>% 
  layout(title = "Number of Quitline Calls for Counseling/Medication per 
         Tobacco Users in 2020", geo = g)
```




